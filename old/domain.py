#!/usr/bin/python

import urllib
import re
import string
import time
from time import localtime, strftime
from lxml import etree
from lxml.etree import Element

langs=["AC",
       "AD",
       "AE",
       "AERO",
       "AF",
       "AG",
       "AI",
       "AL",
       "AM",
       "AN",
       "AO",
       "AQ",
       "AR",
       "ARPA",
       "AS",
       "AT",
       "AU",
       "AW",
       "AZ",
       "BA",
       "BB",
       "BD",
       "BE",
       "BF",
       "BG",
       "BH",
       "BI",
       "BIZ",
       "BJ",
       "BM",
       "BN",
       "BO",
       "BR",
       "BS",
       "BT",
       "BV",
       "BW",
       "BY",
       "BZ",
       "CA",
       "CC",
       "CD",
       "CF",
       "CG",
       "CH",
       "CI",
       "CK",
       "CL",
       "CM",
       "CN",
       "CO",
       "COM",
       "COOP",
       "CR",
       "CU",
       "CV",
       "CX",
       "CY",
       "CZ",
       "DE",
       "DJ",
       "DK",
       "DM",
       "DO",
       "DZ",
       "EC",
       "EDU",
       "EE",
       "EG",
       "ER",
       "ES",
       "ET",
       "EU",
       "FI",
       "FJ",
       "FK",
       "FM",
       "FO",
       "FR",
       "GA",
       "GB",
       "GD",
       "GE",
       "GF",
       "GG",
       "GH",
       "GI",
       "GL",
       "GM",
       "GN",
       "GOV",
       "GP",
       "GQ",
       "GR",
       "GS",
       "GT",
       "GU",
       "GW",
       "GY",
       "HK",
       "HM",
       "HN",
       "HR",
       "HT",
       "HU",
       "ID",
       "IE",
       "IL",
       "IM",
       "IN",
       "INFO",
       "INT",
       "IO",
       "IQ",
       "IR",
       "IS",
       "IT",
       "JE",
       "JM",
       "JO",
       "JP",
       "KE",
       "KG",
       "KH",
       "KI",
       "KM",
       "KN",
       "KR",
       "KW",
       "KY",
       "KZ",
       "LA",
       "LB",
       "LC",
       "LI",
       "LK",
       "LR",
       "LS",
       "LT",
       "LU",
       "LV",
       "LY",
       "MA",
       "MC",
       "MD",
       "MG",
       "MH",
       "MIL",
       "MK",
       "ML",
       "MM",
       "MN",
       "MO",
       "MP",
       "MQ",
       "MR",
       "MS",
       "MT",
       "MU",
       "MUSEUM",
       "MV",
       "MW",
       "MX",
       "MY",
       "MZ",
       "NA",
       "NAME",
       "NC",
       "NE",
       "NET",
       "NF",
       "NG",
       "NI",
       "NL",
       "NO",
       "NP",
       "NR",
       "NU",
       "NZ",
       "OM",
       "ORG",
       "PA",
       "PE",
       "PF",
       "PG",
       "PH",
       "PK",
       "PL",
       "PM",
       "PN",
       "PR",
       "PRO",
       "PS",
       "PT",
       "PW",
       "PY",
       "QA",
       "RE",
       "RO",
       "RU",
       "RW",
       "SA",
       "SB",
       "SC",
       "SD",
       "SE",
       "SG",
       "SH",
       "SI",
       "SJ",
       "SK",
       "SL",
       "SM",
       "SN",
       "SO",
       "SR",
       "ST",
       "SU",
       "SV",
       "SY",
       "SZ",
       "TC",
       "TD",
       "TF",
       "TG",
       "TH",
       "TJ",
       "TK",
       "TL",
       "TM",
       "TN",
       "TO",
       "TP",
       "TR",
       "TT",
       "TV",
       "TW",
       "TZ",
       "UA",
       "UG",
       "UK",
       "UM",
       "US",
       "UY",
       "UZ",
       "VA",
       "VC",
       "VE",
       "VG",
       "VI",
       "VN",
       "VU",
       "WF",
       "WS",
       "YE",
       "YT",
       "YU",
       "ZA",
       "ZM",
       "ZW"]
def parse():
    urls=[]
    urls.append("http://creativecommons.org/licenses/publicdomain/")
    parsetree=etree.parse('api/licenses.xml')
    parseroot=parsetree.getroot()
    for element in parseroot.getiterator('jurisdiction'):
        if element.get('id')=='-':
            for sub in element.getchildren():
                urls.append(sub.get('uri'))
    return urls

def run():
    date=strftime("%Y-%m-%d",localtime())
    root=Element("Dataset")
    tree=etree.ElementTree(element=root)
    root.set("Date",date)
    prefix = "http://search.yahoo.com/search?p=link:"
    midfix = "&vs=."
    urls=parse()
    for l in langs:
        total=0
        node=etree.SubElement(root,"Trawl")
        node.set("Domain",l)
        for url in urls:
            try:
                results = urllib.urlopen(prefix+url+midfix+l).read()
                count = re.search('of about <.*?>(\S+?)<',results).group(1)
                count = string.replace(count,',','')
                total += int(count)
            except:
                count = '!'
            subnode=etree.SubElement(node,"Search")
            subnode.set("URI",url)
            subnode.text=str(count)
            time.sleep(1)
        totnode=etree.SubElement(node,"Total")
        totnode.text=str(total)
    fileopen=open('/web/teamspace/www/stats/domains.xml','w')
    tree.write(fileopen)

run()
